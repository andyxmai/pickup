{% extends "base.html" %}
{% block content %}
<style>
  html, body, #map-canvas {
    width:95%;
    height: 98%;
    padding: 50px 0px 20px 0px;
    margin: 0 auto;
  }
</style>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js"></script>

<script>

var infowindow=null;
var markers= new Array ();

function initialize() {

  var myLatlng = new google.maps.LatLng(37.422, -122.16);
  var initialLocation;
  var browserSupportFlag = new Boolean();

  var mapOptions = {
    zoom: 14,
    //center: myLatlng
  };

  var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
  
  if(navigator.geolocation) {
    browserSupportFlag = true;
    navigator.geolocation.getCurrentPosition(function(position) {
      initialLocation = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
      map.setCenter(initialLocation);

      var image = 'http://i.stack.imgur.com/orZ4x.png';
      var userLocationMarker = new google.maps.Marker({
        position: initialLocation,
        map: map,
        icon: image
      });
    }, function() {
      handleNoGeolocation(browserSupportFlag);
    });
  } else {
    browserSupportFlag = false;
    handleNoGeolocation(browserSupportFlag);
  }

  function handleNoGeolocation(errorFlag) {
    if (errorFlag == true) {
      alert("Geolocation service failed.");
      initialLocation = myLatlng;
    } else {
      alert("Your browser doesn't support geolocation. We've placed you in Siberia.");
      initialLocation = myLatlng;
    }
    map.setCenter(initialLocation);
  }

  var locations = new Array();
  var games={};

  var json = '{{games_json|safe}}';
  var json_game_string = JSON.parse(json);
  //console.log(json_game_string);

  var i=0
  for (var key in json_game_string) {
    if (json_game_string.hasOwnProperty(key)) {
      var hash_key = key;
      var object = json_game_string[key];
      var lat = object['location_info']['latitude'];
      var longi = object ['location_info']['longitude'];
      games[hash_key]= object['games']
      locations[i]= new Array();
      locations[i].push(hash_key);
      locations[i].push(lat);
      locations[i].push(longi);
      i+=1;
    }

  }


  
  var marker; 
  var curr_sport;

  var infowindow = new google.maps.InfoWindow;
  
  var games_by_loc = {};

  for (var key in games) {
    if (json_game_string.hasOwnProperty(key)) {
      games_by_loc[key] = [new Array()];
    }
    var i=0;
    for (var key_2 in games[key]) {
      games_by_loc[key][i]=new Array();
      var curr_game = (games[key][key_2]);
      var game_id = curr_game['id'];
      var sport = curr_game['sport'];
      var name = curr_game['name'];
      var remaining= curr_game['curr_num_players'];
      var total = curr_game['max_num_players'];
      if (!total){
        total="Unlimited";
      }
      var game_string = '<div>'+sport+': '+ "<a href ='/game/"+game_id+"' style='color:red; text-decoration:underline'>"+ name+"</a> (" + remaining + "/" + total +")</div>"
      games_by_loc[key][i].push(game_string);
      i+=1;
    }
  }


  var content_1;
  var content_2; 
  var myIcon;

  for (i = 0; i < locations.length; i++) { 
      loc = locations[i][0]
      for (j=0; j<games_by_loc[loc].length; j++){
        loc_string=games_by_loc[loc][j][0]
        sport= loc_string.split("<div>");
        curr_sport=sport[1].split(":")[0];
        var markerImage = new google.maps.MarkerImage(
        '/static/images/'+curr_sport+'.png',
         new google.maps.Size(50,50), //size
         null, //origin
         null, //anchor
         new google.maps.Size(50,50) //scale
         );
         marker = new google.maps.Marker({
          position: new google.maps.LatLng(locations[i][1], locations[i][2]),
          map: map,
          title: curr_sport,
          icon: markerImage
        });
       
      }

      markers.push(marker);

      google.maps.event.addListener(marker, 'click', (function(marker, i) {
        return function() {
          var content_1 = '<div style="font-weight:bold; text-align:center">' + locations[i][0] + '</div>';
          loc = locations[i][0]
          
          for (j=0; j<games_by_loc[loc].length; j++){
              content_1 += '<p>' + games_by_loc[loc][j] + '</p>';
          }
          infowindow.setContent(content_1);
          infowindow.open(map, marker);
        }
      })(marker, i));
  }
}


google.maps.event.addDomListener(window, 'load', initialize);

 function boxclick(box,category,type) {
        if (box.checked) {
          show(category, type);
        } else {
          hide(category, type);
        }
  }
 function show(category, type) {
       for (var i=0; i<markers.length; i++) {
         if (markers[i].getTitle() == type){
            markers[i].setVisible(true);
         }
       }
       // == check the checkbox ==
        console.log(type);
       console.log(category);
       document.getElementById(type).checked = true;
     }

function hide(category,type){
  for (var i=0; i<markers.length; i++) {
         if (markers[i].getTitle() == type){
          markers[i].setVisible(false);
         }
       }
       // == check the checkbox ==
       console.log(type);
       console.log(category);
       document.getElementById(type).checked = false;
     }

</script>
  {% if messages %}
  <section style="padding-bottom:0">
    {% for message in messages %}
    <div class="alert alert-success alert-dismissable" style="margin-bottom:0; text-align: center">
      <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
      {{message}}
    </div>
    {% endfor %}
  </section>
  {% endif %}
  <div style="float:right">
    <a href="/create_game" type="button" class="btn btn-success" style="position: relative; z-index:2">
      <i class="fa fa-pencil fa-lg"></i> Create Game</a>
  </div> 
  <div id="map-canvas" style= "position:relative; z-index:1"></div>
    <!-- <a href="/logout" type="button" class="btn btn-primary">Logout</a>  -->

<label><input type="checkbox" id="basketball" onclick="boxclick(this,'sport','basketball')" /> Basketball </label>
<label><input type="checkbox" id="football" onclick="boxclick(this,'sport','football')" /> Football </label> 
<label><input type="checkbox" id="soccer" onclick="boxclick(this,'sport','soccer')" /> Soccer</label>
<label><input type="checkbox" id="frisbee" onclick="boxclick(this,'sport','frisbee)" /> Frisbee</label>
<label><input type="checkbox" id="tennis" onclick="boxclick(this,'sport','tennis')" />Tennis</label>
<label><input type="checkbox" id="golf" onclick="boxclick(this,'sport','golf')" />Golf</label>
<label><input type="checkbox" id="volleyball" onclick="boxclick(this,'sport','volleyball')" />Volleyball</label>

{%endblock%}